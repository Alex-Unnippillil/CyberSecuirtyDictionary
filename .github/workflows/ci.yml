name: CI

on:
  push:
  pull_request:

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      - name: Install linters
        run: npm install --no-save eslint@8 stylelint cspell
      - name: ESLint
        run: npx eslint@8 --no-eslintrc --env browser --env es2021 script.js
      - name: stylelint
        run: npx stylelint styles.css
      - name: cSpell
        run: npx cspell README.md terms.json
      - name: Link checker
        uses: lycheeverse/lychee-action@v2
        with:
          args: --no-cache terms.json
      - name: Bias language scan
        id: bias
        run: node scripts/check-bias.js || true
      - name: Comment bias findings
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = JSON.parse(fs.readFileSync('bias_report.json', 'utf8'));
            if (report.length > 0) {
              const lines = report.map(r => `- **${r.term}**: contains "${r.phrase}"`);
              const body = ['## Biased language detected', '', ...lines].join('\n');
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body
              });
              core.setFailed('Biased language found');
            }
      - name: Fail if bias detected
        if: github.event_name != 'pull_request'
        run: |
          if [ -s bias_report.json ] && [ "$(cat bias_report.json)" != "[]" ]; then
            echo 'Biased language found';
            exit 1;
          fi
